# ORC System MQTT Data Flow & Topic Registry

This document describes how sensor data is published from the Open Reactor Control System (ORC) to an MQTT broker, including topic structure, payload format, and sensor mapping.

---

## MQTT Topic Structure

The ORC system publishes two types of sensor data:

### 1. External Sensor Data (from I/O Controller via IPC)
| Sensor Type         | Topic Prefix                | Example Topic                  |
|---------------------|----------------------------|-------------------------------|
| Power               | orcs/sensors/power         | orcs/sensors/power/0          |
| Temperature         | orcs/sensors/temperature   | orcs/sensors/temperature/0    |
| pH                  | orcs/sensors/ph            | orcs/sensors/ph/0             |
| Dissolved Oxygen    | orcs/sensors/do            | orcs/sensors/do/0             |
| Optical Density     | orcs/sensors/od            | orcs/sensors/od/0             |
| Gas Flow            | orcs/sensors/gasflow       | orcs/sensors/gasflow/0        |
| Pressure            | orcs/sensors/pressure      | orcs/sensors/pressure/0       |
| Stirrer Speed       | orcs/sensors/stirrer       | orcs/sensors/stirrer/0        |
| Weight              | orcs/sensors/weight        | orcs/sensors/weight/0         |

### 2. System Status Data (from RP2040 Controller)
| Data Type           | Topic                           | Description                    |
|---------------------|--------------------------------|--------------------------------|
| Power Voltage       | orcs/system/power/voltage      | Main PSU voltage (V)           |
| 20V Rail            | orcs/system/power/20v          | 20V rail voltage (V)           |
| 5V Rail             | orcs/system/power/5v           | 5V rail voltage (V)            |
| PSU Status          | orcs/system/status/psu_ok      | PSU OK status (1=OK, 0=Fault) |
| 20V Status          | orcs/system/status/20v_ok      | 20V rail OK (1=OK, 0=Fault)   |
| 5V Status           | orcs/system/status/5v_ok       | 5V rail OK (1=OK, 0=Fault)    |
| SD Card Status      | orcs/system/status/sdcard_ok   | SD card OK (1=OK, 0=Fault)    |
| IPC Status          | orcs/system/status/ipc_ok      | IPC OK (1=OK, 0=Fault)        |
| RTC Status          | orcs/system/status/rtc_ok      | RTC OK (1=OK, 0=Fault)        |
| Modbus Connection   | orcs/system/status/modbus_connected | Modbus connected (1=Connected, 0=Not) |
| Modbus Busy         | orcs/system/status/modbus_busy | Modbus busy (1=Busy, 0=Idle)  |
| Webserver Status    | orcs/system/status/webserver_up | Webserver up (1=Up, 0=Down)   |
| Webserver Busy      | orcs/system/status/webserver_busy | Webserver busy (1=Busy, 0=Idle) |
| MQTT Connection     | orcs/system/status/mqtt_connected | MQTT connected (1=Connected, 0=Not) |
| MQTT Busy           | orcs/system/status/mqtt_busy   | MQTT busy (1=Busy, 0=Idle)    |

### 3. Consolidated Data Topics
| Topic                    | Description                                    |
|--------------------------|------------------------------------------------|
| orcs/system/sensors      | All system status data in one JSON payload    |

---

## Data Publishing Logic

### External Sensor Data (IPC)
- Data is received from the I/O Controller via IPC and immediately published to the MQTT broker.
- The topic is determined by the sensor type and object ID using the registry above.
- Published to topics like `orcs/sensors/temperature/0`

### System Status Data (RP2040)
- Data is collected locally by the RP2040 controller (power readings, component status, etc.).
- Published periodically to `orcs/system/` topics
- Also consolidated into `orcs/system/sensors` topic

### Payload Format
Both types of data use the same JSON payload format:
- **value**: The sensor reading (float)
- **online**: Sensor online status (boolean) 
- **timestamp**: ISO 8601 UTC timestamp generated by the RP2040 controller

---

## Example MQTT Payloads

### Individual Sensor Topic
```json
{
  "timestamp": "2025-07-19T10:30:00Z",
  "value": 37.50,
  "online": true
}
```

### Consolidated System Status Topic (`orcs/system/sensors`)
```json
{
  "sensors": {
    "orcs/system/power/voltage": { "value": 23.62, "timestamp": "2025-07-18T14:23:45Z" },
    "orcs/system/power/20v": { "value": 19.93, "timestamp": "2025-07-18T14:23:45Z" },
    "orcs/system/status/psu_ok": { "value": 1.00, "timestamp": "2025-07-18T14:23:45Z" }
  }
}
```

---

## Data Flow Summary

### External Sensors (via IPC)
1. Sensor reading is acquired by the I/O Controller.
2. Data is sent to the System Controller (RP2040) via IPC.
3. RP2040 formats the data and publishes it to the MQTT broker on `orcs/sensors/` topics.
4. Each sensor type and instance is mapped to a unique topic for easy subscription and filtering.

### System Status (RP2040 Local)
1. RP2040 controller monitors its own systems (power, network, storage, etc.).
2. Data is collected and formatted locally.
3. Published to `orcs/system/` topics individually and consolidated in `orcs/system/sensors`.

---

## Reference: Topic Registry Sources

### External Sensor Registry (IPC)
```cpp
const std::map<MessageTypes, const char*> MqttTopicRegistry = {
    {MSG_POWER_SENSOR, "orcs/sensors/power"},
    {MSG_TEMPERATURE_SENSOR, "orcs/sensors/temperature"},
    {MSG_PH_SENSOR, "orcs/sensors/ph"},
    {MSG_DO_SENSOR, "orcs/sensors/do"},
    {MSG_OD_SENSOR, "orcs/sensors/od"},
    {MSG_GAS_FLOW_SENSOR, "orcs/sensors/gasflow"},
    {MSG_PRESSURE_SENSOR, "orcs/sensors/pressure"},
    {MSG_STIRRER_SPEED_SENSOR, "orcs/sensors/stirrer"},
    {MSG_WEIGHT_SENSOR, "orcs/sensors/weight"}
};
```

### System Status Registry (RP2040)
```cpp
MqttTopicEntry mqttTopics[] = {
    {"orcs/system/power/voltage", getVpsu, "Main PSU voltage (V)"},
    {"orcs/system/power/20v", getV20, "20V rail voltage (V)"},
    {"orcs/system/power/5v", getV5, "5V rail voltage (V)"},
    {"orcs/system/status/psu_ok", getPsuOK, "PSU OK status (1=OK, 0=Fault)"},
    // ... more status topics
};
```

---

## Notes
- All payloads are JSON and use ISO 8601 timestamps.
- **External sensor topics** (`orcs/sensors/`) are for actual sensor readings from the I/O controller.
- **System status topics** (`orcs/system/`) are for RP2040 controller health and status monitoring.
- Topics are designed for scalability and easy integration with external systems.
- The registry makes it simple to add new sensor types or instances.
- Both individual topics and consolidated topics are published for flexibility.

## Subscription Examples

### Subscribe to all external sensor data:
```bash
mosquitto_sub -h broker -t "orcs/sensors/#"
```

### Subscribe to all system status data:
```bash
mosquitto_sub -h broker -t "orcs/system/#"
```

### Subscribe to consolidated system status:
```bash
mosquitto_sub -h broker -t "orcs/system/sensors"
```

### Subscribe to everything:
```bash
mosquitto_sub -h broker -t "orcs/#"
```
