const DASHBOARD_ICONS={sensor:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M13,5C15.21,5 17,6.79 17,9C17,10.5 16.2,11.77 15,12.46V12.5A1,1 0 0,1 14,13.5H12A1,1 0 0,1 11,12.5V12.46C9.8,11.77 9,10.5 9,9C9,6.79 10.79,5 13,5M20,19.59V8L14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18C18.45,22 18.85,21.85 19.19,21.6L14.76,17.17C13.79,17.69 12.7,18 11.5,18A6.5,6.5 0 0,1 5,11.5A6.5,6.5 0 0,1 11.5,5C14.59,5 17.16,7.18 17.8,10.08L20,12.28V19.59Z"/></svg>',output:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M12,3A2,2 0 0,1 14,5C14,5.74 13.6,6.39 13,6.73V8H19A1,1 0 0,1 20,9V10H22V14H20V15A1,1 0 0,1 19,16H13V20H15V22H9V20H11V16H5A1,1 0 0,1 4,15V14H2V10H4V9A1,1 0 0,1 5,8H11V6.73C10.4,6.39 10,5.74 10,5A2,2 0 0,1 12,3M5,10V14H19V10H5Z"/></svg>',motor:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16Z"/></svg>',controller:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M7,2V4H8V18A4,4 0 0,0 12,22A4,4 0 0,0 16,18V4H17V2H7M11,16C10.4,16 10,15.6 10,15C10,14.4 10.4,14 11,14C11.6,14 12,14.4 12,15C12,15.6 11.6,16 11,16M13,12C12.4,12 12,11.6 12,11C12,10.4 12.4,10 13,10C13.6,10 14,10.4 14,11C14,11.6 13.6,12 13,12M14,7H10V4H14V7Z"/></svg>',energy:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M11,15H13V17H11V15M11,7H13V13H11V7M12,2C6.47,2 2,6.5 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20Z"/></svg>',running:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M8,5.14V19.14L19,12.14L8,5.14Z"/></svg>',stopped:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M18,18H6V6H18V18Z"/></svg>',fault:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M13,14H11V10H13M13,18H11V16H13M1,21H23L12,2L1,21Z"/></svg>',offline:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4M9,9V15H15V9"/></svg>',enableAll:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M10,17L5,12L6.41,10.58L10,14.17L17.59,6.58L19,8M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/></svg>',disableAll:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M12,2C17.53,2 22,6.47 22,12C22,17.53 17.53,22 12,22C6.47,22 2,17.53 2,12C2,6.47 6.47,2 12,2M15.59,7L12,10.59L8.41,7L7,8.41L10.59,12L7,15.59L8.41,17L12,13.41L15.59,17L17,15.59L13.41,12L17,8.41L15.59,7Z"/></svg>',clearVolumes:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M19.36,2.72L20.78,4.14L15.06,9.85C16.13,11.39 16.28,13.24 15.38,14.44L9.06,8.12C10.26,7.22 12.11,7.37 13.65,8.44L19.36,2.72M5.93,17.57C3.92,15.56 2.69,13.16 2.35,10.92L7.23,8.83L14.67,16.27L12.58,21.15C10.34,20.81 7.94,19.58 5.93,17.57Z"/></svg>',saveLayout:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z"/></svg>',config:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M5,3C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V12H19V19H5V5H12V3H5M17.78,4C17.61,4 17.43,4.07 17.3,4.2L16.08,5.41L18.58,7.91L19.8,6.7C20.06,6.44 20.06,6 19.8,5.75L18.25,4.2C18.12,4.07 17.95,4 17.78,4M15.37,6.12L8,13.5V16H10.5L17.87,8.62L15.37,6.12Z"/></svg>',forward:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/></svg>',reverse:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M15.41,16.58L10.83,12L15.41,7.41L14,6L8,12L14,18L15.41,16.58Z"/></svg>',drag:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M9,3H11V5H9V3M13,3H15V5H13V3M9,7H11V9H9V7M13,7H15V9H13V7M9,11H11V13H9V11M13,11H15V13H13V11M9,15H11V17H9V15M13,15H15V17H13V15M9,19H11V21H9V19M13,19H15V21H13V19Z"/></svg>'};let dashboardData=null,dashboardLayout=[],layoutModified=!1;function initDashboardTab(){console.log("[DASHBOARD] Initializing dashboard tab");const a=document.getElementById("dashboard-tiles");a&&(a.innerHTML='<div class="loading">Loading dashboard...</div>'),PollingManager.startPolling("dashboard-api",fetchAndRenderDashboard,2e3),loadDashboardLayout()}async function fetchAndRenderDashboard(){const a="/api/dashboard";try{const e=await fetch(a);if(!e.ok)throw new Error("Failed to fetch dashboard data");dashboardData=await e.json(),PollingManager.recordSuccess(a,dashboardData),renderDashboard(),renderAlarmSummary()}catch(e){console.error("[DASHBOARD] Fetch error:",e);PollingManager.recordError(a);if(PollingManager.shouldShowError(a)){const a=document.getElementById("dashboard-tiles");a&&(a.innerHTML='<div class="error-message">Failed to load dashboard data. Retrying...</div>')}else{const e=PollingManager.getCachedData(a);e&&(dashboardData=e,renderDashboard(),renderAlarmSummary())}}}async function loadDashboardLayout(){try{const a=await fetch("/api/dashboard/layout");if(a.ok){const e=await a.json();dashboardLayout=e.tiles||[],layoutModified=!1,console.log("[DASHBOARD] Layout loaded:",dashboardLayout.length,"tiles")}}catch(a){console.error("[DASHBOARD] Failed to load layout:",a),dashboardLayout=[]}}function renderDashboard(){const a=document.getElementById("dashboard-tiles");if(!a||!dashboardData)return;const e=dashboardData.objects||[];if(0===e.length)return void(a.innerHTML='\n            <div class="dashboard-empty">\n                <p>No objects configured for dashboard display.</p>\n                <p class="hint">Enable "Show on Dashboard" in each object\'s configuration.</p>\n            </div>\n        ');let t=[...e];dashboardLayout.length>0&&t.sort((a,e)=>{const t=dashboardLayout.findIndex(e=>e.type===a.type&&e.index===a.index),s=dashboardLayout.findIndex(a=>a.type===e.type&&a.index===e.index);return-1===t&&-1===s?0:-1===t?1:-1===s?-1:t-s}),a.innerHTML=t.map(a=>createDashboardTile(a)).join(""),updateAlarmBadge()}function createDashboardTile(a){const e=getObjectTypeIcon(a.type),t=getStatusClass(a),s=getStatusBadge(a);let o="";return o=a.online?"energy"===a.type?formatEnergyDisplay(a):"stepper"===a.type||"dcmotor"===a.type?formatMotorDisplay(a):"temp_controller"===a.type||"ph_controller"===a.type||"flow_controller"===a.type||"do_controller"===a.type?formatControllerDisplay(a):`<span class="tile-value">${formatValue(a.value)}</span>\n                           <span class="tile-unit">${a.unit||""}</span>`:'<span class="tile-offline">OFFLINE</span>',`\n        <div class="dashboard-tile ${t}" data-type="${a.type}" data-index="${a.index}">\n            <div class="tile-drag-handle" title="Drag to reorder">\n                ${DASHBOARD_ICONS.drag}\n            </div>\n            <div class="tile-header">\n                <span class="tile-icon">${e}</span>\n                <span class="tile-name">${a.name}</span>\n                ${s}\n            </div>\n            <div class="tile-content">\n                ${o}\n            </div>\n            ${a.message?`<div class="tile-message">${a.message}</div>`:""}\n        </div>\n    `}function getObjectTypeIcon(a){switch(a){case"adc":case"rtd":case"gpio":case"device_sensor":default:return DASHBOARD_ICONS.sensor;case"dac":case"digital_output":return DASHBOARD_ICONS.output;case"stepper":case"dcmotor":return DASHBOARD_ICONS.motor;case"temp_controller":case"ph_controller":case"flow_controller":case"do_controller":return DASHBOARD_ICONS.controller;case"energy":return DASHBOARD_ICONS.energy}}function getStatusClass(a){return a.online?a.fault?"tile-fault":a.running?"tile-running":"tile-normal":"tile-offline"}function getStatusBadge(a){return a.online?a.fault?`<span class="tile-badge tile-badge-fault">${DASHBOARD_ICONS.fault} FAULT</span>`:a.running?`<span class="tile-badge tile-badge-running">${DASHBOARD_ICONS.running} RUNNING</span>`:"":`<span class="tile-badge tile-badge-offline">${DASHBOARD_ICONS.offline} OFFLINE</span>`}function formatValue(a){return null==a||isNaN(a)?"--":Number(a).toFixed(2)}function formatEnergyDisplay(a){const e=formatValue(a.value);let t="--",s="--";return a.additionalValues&&a.additionalValues.length>=2&&(t=formatValue(a.additionalValues[0].value),s=formatValue(a.additionalValues[1].value)),`\n        <div class="energy-display">\n            <div class="energy-row"><span class="label">Voltage:</span> <span class="value">${e}</span> <span class="unit">V</span></div>\n            <div class="energy-row"><span class="label">Current:</span> <span class="value">${t}</span> <span class="unit">A</span></div>\n            <div class="energy-row"><span class="label">Power:</span> <span class="value">${s}</span> <span class="unit">W</span></div>\n        </div>\n    `}function formatMotorDisplay(a){const e=a.direction?DASHBOARD_ICONS.forward:DASHBOARD_ICONS.reverse,t=a.direction?"FWD":"REV",s="stepper"===a.type?"RPM":"Power",o="stepper"===a.type?"RPM":"%";return`\n        <div class="motor-display">\n            <div class="motor-value">\n                <span class="label">${s}:</span>\n                <span class="value">${formatValue(a.value)}</span>\n                <span class="unit">${o}</span>\n            </div>\n            <div class="motor-direction">\n                <span class="dir-icon">${e}</span>\n                <span class="dir-text">${t}</span>\n            </div>\n        </div>\n    `}function formatControllerDisplay(a){const e=formatValue(a.value),t=a.setpoint?formatValue(a.setpoint):"--",s=a.output?formatValue(a.output):"--";return`\n        <div class="controller-display">\n            <div class="ctrl-row"><span class="label">PV:</span> <span class="value">${e}</span> <span class="unit">${a.unit||""}</span></div>\n            <div class="ctrl-row"><span class="label">SP:</span> <span class="value">${t}</span> <span class="unit">${a.unit||""}</span></div>\n            <div class="ctrl-row"><span class="label">Out:</span> <span class="value">${s}</span> <span class="unit">%</span></div>\n        </div>\n    `}function renderAlarmSummary(){const a=document.getElementById("alarm-summary");if(!a||!dashboardData)return;const e=dashboardData.faultCount||0,t=dashboardData.alarms||[];a.innerHTML=0!==e?`\n        <div class="alarm-summary alarm-fault">\n            <div class="alarm-header">\n                <span class="alarm-icon">${DASHBOARD_ICONS.fault}</span>\n                <span class="alarm-count">${e} Active Alarm${e>1?"s":""}</span>\n            </div>\n            <ul class="alarm-list">\n                ${t.map(a=>`<li><strong>${a.name}</strong>: ${a.message||"Fault detected"}</li>`).join("")}\n            </ul>\n        </div>\n    `:`\n            <div class="alarm-summary alarm-ok">\n                <span class="alarm-icon">${DASHBOARD_ICONS.enableAll}</span>\n                <span class="alarm-text">All systems normal</span>\n            </div>\n        `}function updateAlarmBadge(){const a=document.getElementById("alarm-badge");if(!a||!dashboardData)return;const e=dashboardData.faultCount||0;e>0?(a.textContent=e,a.classList.add("visible")):a.classList.remove("visible")}async function enableAllOutputs(){if(confirm("Enable all outputs and controllers?"))try{if(!(await fetch("/api/dashboard/enable-all",{method:"POST"})).ok)throw new Error("Failed to enable all");showToast("success","Enable All","All outputs and controllers enabled")}catch(a){console.error("[DASHBOARD] Enable all error:",a),showToast("error","Error","Failed to enable outputs")}}async function disableAllOutputs(){if(confirm("Disable all outputs and controllers?"))try{if(!(await fetch("/api/dashboard/disable-all",{method:"POST"})).ok)throw new Error("Failed to disable all");showToast("success","Disable All","All outputs and controllers disabled")}catch(a){console.error("[DASHBOARD] Disable all error:",a),showToast("error","Error","Failed to disable outputs")}}async function clearAllVolumes(){if(confirm("Clear all cumulative dosing volumes?"))try{if(!(await fetch("/api/dashboard/clear-volumes",{method:"POST"})).ok)throw new Error("Failed to clear volumes");showToast("success","Clear Volumes","All cumulative volumes reset")}catch(a){console.error("[DASHBOARD] Clear volumes error:",a),showToast("error","Error","Failed to clear volumes")}}function onTileOrderChanged(){const a=document.getElementById("dashboard-tiles");if(!a)return;const e=a.querySelectorAll(".dashboard-tile");dashboardLayout=Array.from(e).map(a=>({type:a.dataset.type,index:parseInt(a.dataset.index)})),layoutModified=!0,updateSaveLayoutButton()}function updateSaveLayoutButton(){const a=document.getElementById("save-layout-btn");a&&(a.disabled=!layoutModified,a.classList.toggle("modified",layoutModified))}async function saveDashboardLayout(){if(layoutModified)try{if(!(await fetch("/api/dashboard/layout",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tiles:dashboardLayout})})).ok)throw new Error("Failed to save layout");layoutModified=!1,updateSaveLayoutButton(),showToast("success","Layout Saved","Dashboard layout saved to flash")}catch(a){console.error("[DASHBOARD] Save layout error:",a),showToast("error","Error","Failed to save layout")}}function initDragAndDrop(){const a=document.getElementById("dashboard-tiles");if(!a)return;let e=null;a.addEventListener("dragstart",a=>{const t=a.target.closest(".dashboard-tile");t&&(e=t,t.classList.add("dragging"),a.dataTransfer.effectAllowed="move")}),a.addEventListener("dragend",a=>{e&&(e.classList.remove("dragging"),e=null,onTileOrderChanged())}),a.addEventListener("dragover",t=>{t.preventDefault(),t.dataTransfer.dropEffect="move";const s=getDragAfterElement(a,t.clientY);e&&(null==s?a.appendChild(e):a.insertBefore(e,s))})}function getDragAfterElement(a,e){return[...a.querySelectorAll(".dashboard-tile:not(.dragging)")].reduce((a,t)=>{const s=t.getBoundingClientRect(),o=e-s.top-s.height/2;return o<0&&o>a.offset?{offset:o,element:t}:a},{offset:Number.NEGATIVE_INFINITY}).element}const originalRenderDashboard=renderDashboard;renderDashboard=function(){originalRenderDashboard();document.querySelectorAll(".dashboard-tile").forEach(a=>{a.draggable=!0}),initDragAndDrop()},window.initDashboardTab=initDashboardTab,window.enableAllOutputs=enableAllOutputs,window.disableAllOutputs=disableAllOutputs,window.clearAllVolumes=clearAllVolumes,window.saveDashboardLayout=saveDashboardLayout;